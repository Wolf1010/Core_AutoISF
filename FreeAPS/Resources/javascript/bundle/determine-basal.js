var freeaps_determineBasal;(()=>{var e={5546:(e,r,a)=>{var t=a(6880);function o(e,r){r||(r=0);var a=Math.pow(10,r);return Math.round(e*a)/a}function n(e,r){return"mmol/L"===r.out_units?o(.0555*e,1):Math.round(e)}var i="",s="",l="",u="",d="",m="",c="",p="",b="",g="",f="",h=1,v=1,B=1,_=1,M=1;function S(e,r,a){"bg"==a?(polyX=[50,60,80,90,100,110,150,180,200],polyY=[-.5,-.5,-.3,-.2,0,0,.5,.7,.7]):"delta"==a&&(polyX=[2,7,12,16,20],polyY=[0,0,.4,.7,.7]);var t=polyX.length-1,o=polyX[0],n=polyY[0],i=polyX[t],s=polyY[t],l=1,u=1,d=1,m=o;if(o>e)i=polyX[1],l=(u=n)+((s=polyY[1])-u)/(i-(d=o))*(e-d);else if(i<e)o=polyX[t-1],l=(u=n=polyY[t-1])+(s-u)/(i-(d=o))*(e-d);else for(var c=0;c<=t;c++){if(o=polyX[c],n=polyY[c],o==e){l=n;break}if(o>e){l=u+(n-u)/(o-(d=m))*(e-d);break}u=n,m=o}return l*="delta"==a?r.delta_ISFrange_weight:e>100?r.higher_ISFrange_weight:r.lower_ISFrange_weight}function y(e,r,a,t,n,i,s,l,u){console.error("check ratio "+o(e,2)+" against autoISF min: "+r+" and autoISF max: "+a),e<r?(b=" (lmtd.min)",c="weakest autoISF factor "+o(e,2)+" limited by autoISF_min "+r,console.error(c),e=r):e>a&&(b=" (lmtd.max)",c="strongest autoISF factor "+o(e,2)+" limited by autoISF_max "+a,console.error(c),e=a);var d=1;return s&&i.temptargetSet&&l>u?(d=e*t,n=" (exerciseMode)",console.error("autoISF adjusts sens "+t+", instead of profile.sens "+i.sens),g=n):e>=1?(d=Math.max(e,t),e>=t&&(n="")):(d=Math.min(e,t),e<=t&&(n="")),c="final ISF factor "+o(d,2)+n,console.error(c),d}e.exports=function(e,r,a,x,F,I,w,T,C,O,D,G,R,U){var A=0,E="",P="",j="",k="",q="",W=0,z=0,N=0,L=0,X=0,Y=0;const H=U.tddYtd,Z=U.tdd7d,$=U.hbt,J=U.isEnabled;function K(e,r){var a=e.getTime();return new Date(a+36e5*r)}function Q(e){var r=x.bolus_increment;.025!=r&&(r=.05);var a=e/r;return a>=1?o(Math.floor(a)*r,5):0}function V(e){function r(e){return e<10&&(e="0"+e),e}return r(e.getHours())+":"+r(e.getMinutes())+":00"}function ee(e,r){var a=new Date("1/1/1999 "+e),t=new Date("1/1/1999 "+r);return(a.getTime()-t.getTime())/36e5}function re(e,r){var a=0,t=r,o=(e-r)/36e5,n=0,i=o,s=0;do{if(o>0){var l=V(t);R[0].rate;for(let e=0;e<R.length;e++){var u=R[e].start;if(l==u){if(e+1<R.length){o>=(s=ee(R[e+1].start,R[e].start))?n=s:o<s&&(n=o)}else if(e+1==R.length){let r=R[0].start;o>=(s=24-ee(R[e].start,r))?n=s:o<s&&(n=o)}a+=Q(R[e].rate*n),o-=n,t=K(t,n)}else if(l>u)if(e+1<R.length){var d=R[e+1].start;l<d&&(o>=(s=ee(d,l))?n=s:o<s&&(n=o),a+=Q(R[e].rate*n),o-=n,t=K(t,n))}else if(e==R.length-1){o>=(s=ee("23:59:59",l))?n=s:o<s&&(n=o),a+=Q(R[e].rate*n),o-=n,t=K(t,n)}}}}while(o>0&&o<i);return a}if(D.length){let e=D.length-1;var ae=new Date(D[e].timestamp),te=new Date(D[0].timestamp);if("TempBasalDuration"==D[0]._type&&(te=new Date),(A=(te-ae)/36e5)<23.9&&A>21)X=re(ae,(oe=24-A,ne=ae.getTime(),new Date(ne-36e5*oe))),k="24 hours of data is required for an accurate tdd calculation. Currently only "+A.toPrecision(3)+" hours of pump history data are available. Using your pump scheduled basals to fill in the missing hours. Scheduled basals added: "+X.toPrecision(5)+" U. ";else A<21?(dynISFenabled=!1,enableDynamicCR=!1):k=""}else console.log("Pumphistory is empty!"),dynISFenabled=!1,enableDynamicCR=!1;var oe,ne;for(let e=0;e<D.length;e++)"Bolus"==D[e]._type&&(L+=D[e].amount);for(let e=1;e<D.length;e++)if("TempBasal"==D[e]._type&&D[e].rate>0){W=e,Y=D[e].rate;var ie=D[e-1]["duration (min)"]/60,se=ie,le=new Date(D[e-1].timestamp),ue=le;do{if(e--,0==e){ue=new Date;break}if("TempBasal"==D[e]._type||"PumpSuspend"==D[e]._type){ue=new Date(D[e].timestamp);break}}while(e>0);var de=(ue-le)/36e5;de<se&&(ie=de),N+=Q(Y*ie),e=W}for(let e=0;e<D.length;e++)if(0,0==D[e]["duration (min)"]||"PumpResume"==D[e]._type){let r=new Date(D[e].timestamp),a=r,t=e;do{if(t>0&&(--t,"TempBasal"==D[t]._type)){a=new Date(D[t].timestamp);break}}while(t>0);(a-r)/36e5>0&&(X+=re(a,r))}for(let e=D.length-1;e>0;e--)if("TempBasalDuration"==D[e]._type){let r=D[e]["duration (min)"]/60,a=new Date(D[e].timestamp);var me=a;let t=e;do{if(--t,t>=0&&("TempBasal"==D[t]._type||"PumpSuspend"==D[t]._type)){me=new Date(D[t].timestamp);break}}while(t>0);if(0==e&&"TempBasalDuration"==D[0]._type&&(me=new Date,r=D[e]["duration (min)"]/60),(me-a)/36e5-r>0){X+=re(me,K(a,r))}}var ce={TDD:o(z=L+N+X,5),bolus:o(L,5),temp_basal:o(N,5),scheduled_basal:o(X,5)},pe=z;A>21?(P=". Bolus insulin: "+L.toPrecision(5)+" U",j=". Temporary basal insulin: "+N.toPrecision(5)+" U",E=". Insulin with scheduled basal rate: "+X.toPrecision(5)+" U",q=k+(" TDD past 24h is: "+z.toPrecision(5)+" U")+P+j+E,tddReason=", TDD, 24h: "+o(z,1)+", ytd: "+o(H,1)+", 7d√ò: "+o(Z,1),console.error(q)):tddReason=", TDD: Not enough pumpData (< 21h)";var be={},ge=new Date;if(O&&(ge=O),void 0===x||void 0===x.current_basal)return be.error="Error: could not get current basal rate",be;var fe=t(x.current_basal,x),he=fe,ve=new Date;O&&(ve=O);var Be,_e=new Date(e.date),Me=o((ve-_e)/60/1e3,1),Se=e.glucose,ye=e.noise;Be=n(e.delta,x);var xe=Math.min(e.delta,e.short_avgdelta),Fe=Math.min(e.short_avgdelta,e.long_avgdelta),Ie=Math.max(e.delta,e.short_avgdelta,e.long_avgdelta);(Se<=10||38===Se||ye>=3)&&(be.reason="CGM is calibrating, in ??? state, or noise is high");if(Me>12||Me<-5?be.reason="If current system time "+ve+" is correct, then BG data is too old. The last BG data was read "+Me+"m ago at "+_e:Se>60&&e.cgmFlatMinutes>89&&(e.last_cal&&e.last_cal<3?be.reason="CGM was just calibrated":be.reason="Error: CGM data was suspiciously flat for the past ~"+o(e.cgmFlatMinutes,1)+"m"),Se<=10||38===Se||ye>=3||Me>12||Me<-5||Se>60&&e.cgmFlatMinutes>89)return r.rate>he?(be.reason+=". Replacing high temp basal of "+r.rate+" with neutral temp of "+he,be.deliverAt=ge,be.temp="absolute",be.duration=30,be.rate=he,be):0===r.rate&&r.duration>30?(be.reason+=". Shortening "+r.duration+"m long zero temp to 30m. ",be.deliverAt=ge,be.temp="absolute",be.duration=30,be.rate=0,be):(be.reason+=". Temp "+r.rate+" <= current basal "+o(he,2)+"U/hr; doing nothing. ",be);var we,Te,Ce,Oe,De=x.max_iob;if(void 0!==x.min_bg&&(Te=x.min_bg),void 0!==x.max_bg&&(Ce=x.max_bg),void 0!==x.enableSMB_high_bg_target&&(Oe=x.enableSMB_high_bg_target),void 0===x.min_bg||void 0===x.max_bg)return be.error="Error: could not determine target_bg. ",be;we=(x.min_bg+x.max_bg)/2;var Ge="",Re=x.exercise_mode||x.high_temptarget_raises_sensitivity,Ue=100,Ae=160;if(x.half_basal_exercise_target&&(Ae=x.half_basal_exercise_target),J&&(Ae=$),Re&&x.temptargetSet&&we>Ue||x.low_temptarget_lowers_sensitivity&&x.temptargetSet&&we<Ue){var Ee=Ae-Ue;sensitivityRatio=Ee*(Ee+we-Ue)<=0?x.autosens_max:Ee/(Ee+we-Ue),sensitivityRatio=Math.min(sensitivityRatio,x.autosens_max),sensitivityRatio=o(sensitivityRatio,2),Ge="from TT modifier",f+=", Ratio TT: "+sensitivityRatio,process.stderr.write("Sensitivity ratio set to "+sensitivityRatio+" based on temp target of "+we+"; ")}else void 0!==F&&F&&(sensitivityRatio=F.ratio,Ge="from Autosens",process.stderr.write("Autosens ratio: "+sensitivityRatio+"; "));if(sensitivityRatio&&(he=x.current_basal*sensitivityRatio,(he=t(he,x))!==fe?process.stderr.write("Adjusting basal from "+fe+" to "+he+"; "):process.stderr.write("Basal unchanged: "+he+"; ")),x.temptargetSet);else if(void 0!==F&&F&&(x.sensitivity_raises_target&&F.ratio<1||x.resistance_lowers_target&&F.ratio>1)){Te=o((Te-60)/F.ratio)+60,Ce=o((Ce-60)/F.ratio)+60;var Pe=o((we-60)/F.ratio)+60;we===(Pe=Math.max(80,Pe))?process.stderr.write("target_bg unchanged: "+Pe+"; "):process.stderr.write("target_bg from "+we+" to "+Pe+"; "),we=Pe}var je=200,ke=200,qe=200;if(e.noise>=2){var We=Math.max(1.1,x.noisyCGMTargetMultiplier);Math.min(250,x.maxRaw);je=o(Math.min(200,Te*We)),ke=o(Math.min(200,we*We)),qe=o(Math.min(200,Ce*We)),process.stderr.write("Raising target_bg for noisy / raw CGM data, from "+we+" to "+ke+"; "),Te=je,we=ke,Ce=qe}var ze=Te-.5*(Te-40),Ne=o(x.sens,1),Le=x.sens;void 0!==F&&F&&((Le=o(Le=x.sens/sensitivityRatio,1))!==Ne?process.stderr.write("ISF from "+n(Ne,x)+" to "+n(Le,x)):process.stderr.write("ISF unchanged: "+n(Le,x))),console.error("CR:"+x.carb_ratio),console.error("----------------------------------"),console.error(" start autoISF"),console.error("----------------------------------");var Xe=function(e,r){if(e.use_autoisf&&e.iob_threshold>0&&e.iob_threshold<r[0].iob)return s=", autoISF-SMB disabled:, IOB: "+o(r[0].iob,2)+", > threshold: "+e.iob_threshold+", maxIOB: "+e.max_iob,console.error(s),"iobTH";var a=n(e.min_bg,e);return e.use_autoisf&&e.temptargetSet&&e.enableSMB_EvenOn_OddOff||e.use_autoisf&&e.min_bg==e.max_bg&&e.enableSMB_EvenOn_OddOff_always?(e.temptargetSet?msgType="TempTarget ":msgType="profile target ","mmol/L"==e.out_units?(evenTarget=o(10*a,0)%2==0,msgUnits=" has ",msgTail=" decimal"):(evenTarget=a%2==0,msgUnits=" is ",msgTail=" number"),evenTarget?msgEven="even":msgEven="odd",evenTarget?(console.error("SMB enabled - "+msgType+a+msgUnits+msgEven+msgTail),console.error("enableSMB_EvenOn_OddOff = "+e.enableSMB_EvenOn_OddOff+", enableSMB_EvenOn_OddOff_alway = "+e.enableSMB_EvenOn_OddOff_always),e.temptargetSet&&a<100?(console.error("Full Loop enabled, SMB enforced"),s=", autoISF-SMB enabled:, even TT","enforced"):(s=", autoISF-SMB enabled:, even Target","enabled")):(console.error("SMB disabled - "+msgType+a+msgUnits+msgEven+msgTail),s=", autoISF-SMB disabled:, odd Target","blocked")):"oref"}(x,a),Ye=!0;if(T&&"oref"!=Xe?("blocked"==Xe&&(Ye=!1),console.error("loopSMB function overriden with autoISF target toggle, enableSMB = "+Ye)):(Ye=function(e,r,a,t,o,i){return r?!e.allowSMB_with_high_temptarget&&e.temptargetSet&&o>100?(console.error("SMB disabled due to high temptarget of "+o),!1):!0===a.bwFound&&!1===e.A52_risk_enable?(console.error("SMB disabled due to Bolus Wizard activity in the last 6 hours."),!1):!0===e.enableSMB_always?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled due to enableSMB_always"),!0):!0===e.enableSMB_with_COB&&a.mealCOB?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for COB of"+a.mealCOB),!0):!0===e.enableSMB_after_carbs&&a.carbs?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for 6h after carb entry"),!0):!0===e.enableSMB_with_temptarget&&e.temptargetSet&&o<100?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for temptarget of "+n(o,e)),!0):!0===e.enableSMB_high_bg&&null!==i&&t>=i?(console.error("Checking BG to see if High for SMB enablement."),console.error("Current BG",t," | High BG ",i),a.bwFound?console.error("Warning: High BG SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("High BG detected. Enabling SMB."),!0):(console.error("SMB disabled (no enableSMB preferences active or no condition satisfied)"),!1):(console.error("SMB disabled (!microBolusAllowed)"),!1)}(x,T,I,Se,we,Oe),console.error("loopSMB function returns enableSMB = "+Ye)),Le=function(e,r,a,t,f,x,F,I,w,T,C,O){if(!t.use_autoisf)return console.error("autoISF disabled in Preferences"),i+=", autoISF, disabled",e;if(t.autoISF_off_Sport&&(t.high_temptarget_raises_sensitivity||t.exercise_mode)&&t.temptargetSet&&a>O)return console.error("autoISF disabled due to exercise"),i+=", autoISF, disabled (exercise)",e;const D=f.dura_p,G=f.delta_pl,R=f.delta_pn,U=f.r_squ,A=f.bg_acceleration,E=f.a_0,P=f.a_1,j=f.a_2,k=f.dura_ISF_minutes,q=f.dura_ISF_average;var W=t.autoISF_min,z=t.autoISF_max,N=!1,L=e,X=a+10-q,Y=f.pp_debug;if("bg_acceleration: "+o(A,3)+", PF-minutes: "+D+", PF-corr: "+o(U,4)+", PF-nextDelta: "+n(R,t)+", PF-lastDelta: "+n(G,t)+", regular Delta: "+n(f.delta,t),console.error(Y),t.enable_BG_acceleration){var H=U;if(0!=j&&H>=.9){var Z=-P/2/j*5,$=o(E-Z*Z/25*j,1);(Z=o(Z,1))>0&&A<0?(p="predicts a Max of "+n($,t)+", in about "+Math.abs(Z)+"min",console.error("Parabolic fit "+p)):Z>0&&A>0?(p="predicts a Min of "+n($,t)+", in about "+Math.abs(Z)+"min",console.error("Parabolic fit "+p)):Z<0&&A<0?(p="saw Max of "+n($,t)+", about "+Math.abs(Z)+"min ago",console.error("Parabolic fit "+p)):Z<0&&A>0&&(p="saw Min of "+n($,t)+", about "+Math.abs(Z)+"min ago",console.error("Parabolic fit "+p))}if(H<.9)p="acce_ISF by-passed, as correlation, "+o(H,2)+", is too low",console.error("Parabolic fit "+p),m+=", Parabolic Fit, "+p;else{var J=10*(H-.9),K=1,Q=1;f.glucose<t.target_bg?A>0?(A>1&&(K=.5),Q=t.bgBrake_ISF_weight):A<0&&(Q=t.bgAccel_ISF_weight):A<0?Q=t.bgBrake_ISF_weight:A>0&&(Q=t.bgAccel_ISF_weight),(h=1+A*K*Q*J)<0&&(h=.1),console.error(m+"acce_ISF adaptation is "+o(h,2)),1!=h&&(N=!0,m+=", Parabolic Fit, "+p+", acce-ISF Ratio: "+o(h,2))}}else console.error("autoISF BG accelertion adaption disabled in Preferences");i+=s+m+", autoISF",v=1+S(100-X,t,"bg"),console.error("bg_ISF adaptation is "+o(v,2));var V=1,ee=1;if(v<1)return V=Math.min(v,h),h>1?(c="bg-ISF adaptation lifted to "+o(V=v*h,2)+", as BG accelerates already",console.error(c),i+=", bg-ISF Ratio: "+o(V,2)+"(accel.)"):i+=", bg-ISF Ratio: "+o(V,2)+"(minimal)",ee=y(V,W,z,w,r,t,C,a,O),L=Math.min(720,o(t.sens/ee,1)),i+=", bg-ISF Ratio: "+o(ee,2),L;v>1&&(N=!0,i+=", bg-ISF Ratio: "+o(v,2));var re=f.delta;t.enable_pp_ISF_always||t.pp_ISF_hours>=(F-x.lastCarbTime)/1e3/3600?deltaType="pp":deltaType="delta",X>0?console.error(deltaType+"_ISF adaptation by-passed as average glucose < "+a+"+10"):f.short_avgdelta<0?console.error(deltaType+"_ISF adaptation by-passed as no rise or too short lived"):"pp"==deltaType?(_=1+Math.max(0,re*t.pp_ISF_weight),console.error("pp_ISF adaptation is "+o(_,2)),u=", pp-ISF Ratio: "+o(_,2),1!=_&&(N=!0)):(B=S(re,t,"delta"),X>-20&&(B*=.5),B=1+B,console.error("delta_ISF adaptation is "+o(B,2)),d=", Œî-ISF Ratio: "+o(B,2),1!=B&&(N=!0));var ae=t.dura_ISF_weight;x.mealCOB>0&&!t.enableautoisf_with_COB?console.error("dura_ISF by-passed; preferences disabled mealCOB of "+o(x.mealCOB,1)):k<10?console.error("dura_ISF by-passed; BG is only "+k+"m at level "+q):q<=a?console.error("dura_ISF by-passed; avg. glucose "+q+" below target "+n(a,t)):(M+=k/60*(ae/a)*(q-a),N=!0,l=", Duration: "+k+", Avg: "+n(q,t)+", dura-ISF Ratio: "+o(M,2),console.error("dura_ISF adaptation is "+o(M,2)+" because ISF "+e+" did not do it for "+o(k,1)+"m"));return N?(V=Math.max(M,v,B,h,_),console.error("autoISF adaption ratios:"),console.error("  dura "+o(M,2)),console.error("  bg "+o(v,2)),console.error("  delta "+o(B,2)),console.error("  pp "+o(_,2)),console.error("  accel "+o(h,2)),h<1&&(c="strongest ISF factor "+o(V,2)+" weakened to "+o(V*h,2)+" as bg decelerates already",console.error(c),V*=h),ee=y(V,W,z,w,r,t,C,a,O),L=o(t.sens/ee,1),i+=u+d+l+", final Ratio: "+o(ee,2)+g+b+", final ISF: "+n(t.sens,t)+"‚Üí"+n(L,t),L):(i+=", not modified",console.error("autoISF does not modify"),L)}(Le,Ge,we,x,e,I,O,0,sensitivityRatio,0,Re,Ue),console.error("----------------------------------"),console.error(" end autoISF"),console.error("----------------------------------"),void 0===a)return be.error="Error: iob_data undefined. ",be;var He,Ze=a;if(a.length,a.length>1&&(a=Ze[0]),void 0===a.activity||void 0===a.iob)return be.error="Error: iob_data missing some property. ",be;var $e=((He=void 0!==a.lastTemp?o((new Date(ve).getTime()-a.lastTemp.date)/6e4):0)+r.duration)%30;if(console.error("currenttemp:"+r.rate+" lastTempAge:"+He+"m, tempModulus:"+$e+"m"),be.temp="absolute",be.deliverAt=ge,T&&r&&a.lastTemp&&r.rate!==a.lastTemp.rate&&He>10&&r.duration)return be.reason="Warning: currenttemp rate "+r.rate+" != lastTemp rate "+a.lastTemp.rate+" from pumphistory; canceling temp",w.setTempBasal(0,0,x,be,r);if(r&&a.lastTemp&&r.duration>0){var Je=He-a.lastTemp.duration;if(Je>5&&He>10)return be.reason="Warning: currenttemp running but lastTemp from pumphistory ended "+Je+"m ago; canceling temp",w.setTempBasal(0,0,x,be,r)}var Ke=o(-a.activity*Le*5,2),Qe=o(6*(xe-Ke));Qe<0&&(Qe=o(6*(Fe-Ke)))<0&&(Qe=o(6*(e.long_avgdelta-Ke)));var Ve=Se,er=(Ve=a.iob>0?o(Se-a.iob*Le):o(Se-a.iob*Math.min(Le,x.sens)))+Qe;if(void 0===er||isNaN(er))return be.error="Error: could not calculate eventualBG. Sensitivity: "+Le+" Deviation: "+Qe,be;var rr=function(e,r,a){return o(a+(e-r)/24,1)}(we,er,Ke);be={temp:"absolute",bg:n(Se,x),tick:Be,eventualBG:er,insulinReq:0,reservoir:C,deliverAt:ge,sensitivityRatio,TDD:pe,insulin:ce};var ar=[],tr=[],or=[],nr=[];ar.push(Se),tr.push(Se),nr.push(Se),or.push(Se);var ir=x.enableUAM,sr=0,lr=0;sr=o(xe-Ke,1);var ur=o(xe-Ke,1);csf=Le/x.carb_ratio,console.error("profile.sens:"+n(x.sens,x)+", sens:"+n(Le,x)+", CSF:"+o(csf,1));var dr=o(30*csf*5/60,1);sr>dr&&(console.error("Limiting carb impact from "+sr+" to "+dr+"mg/dL/5m (30g/h)"),sr=dr);var mr=3;sensitivityRatio&&(mr/=sensitivityRatio);var cr=mr;if(I.carbs){mr=Math.max(mr,I.mealCOB/20);var pr=o((new Date(ve).getTime()-I.lastCarbTime)/6e4),br=(I.carbs-I.mealCOB)/I.carbs;cr=o(cr=mr+1.5*pr/60,1),console.error("Last carbs "+pr+" minutes ago; remainingCATime:"+cr+"hours; "+o(100*br)+"% carbs absorbed")}var gr=Math.max(0,sr/5*60*cr/2)/csf,fr=90,hr=1;x.remainingCarbsCap&&(fr=Math.min(90,x.remainingCarbsCap)),x.remainingCarbsFraction&&(hr=Math.min(1,x.remainingCarbsFraction));var vr=1-hr,Br=Math.max(0,I.mealCOB-gr-I.carbs*vr),_r=(Br=Math.min(fr,Br))*csf*5/60/(cr/2),Mr=o(I.slopeFromMaxDeviation,2),Sr=o(I.slopeFromMinDeviation,2),yr=Math.min(Mr,-Sr/3),xr=0;0===sr?lr=0:!0===x.floating_carbs?(lr=Math.min(60*cr/5/2,Math.max(0,I.carbs*csf/sr)),xr=Math.min(60*cr/5/2,Math.max(0,I.mealCOB*csf/sr)),I.carbs>0&&(i+=", Floating Carbs:, CID: "+o(lr,1)+", MealCarbs: "+o(I.carbs,1)+", Not Floating:, CID: "+o(xr,1)+", MealCOB: "+o(I.mealCOB,1),console.error("Floating Carbs CID: "+o(lr,1)+" / MealCarbs: "+o(I.carbs,1)+" vs. Not Floating:"+o(xr,1)+" / MealCOB:"+o(I.mealCOB,1)))):lr=Math.min(60*cr/5/2,Math.max(0,I.mealCOB*csf/sr)),console.error("Carb Impact:"+sr+"mg/dL per 5m; CI Duration:"+o(5*lr/60*2,1)+"hours; remaining CI ("+o(cr/2,2)+"h peak):",o(_r,1)+"mg/dL per 5m");var Fr,Ir,wr,Tr,Cr,Or=999,Dr=999,Gr=999,Rr=Se,Ur=999,Ar=999,Er=999,Pr=999,jr=er,kr=Se,qr=Se,Wr=0,zr=[],Nr=[];try{Ze.forEach((function(e){var r=o(-e.activity*Le*5,2),a=o(-e.iobWithZeroTemp.activity*Le*5,2),t=sr*(1-Math.min(1,tr.length/12));jr=tr[tr.length-1]+r+t;var n=nr[nr.length-1]+a,i=Math.max(0,Math.max(0,sr)*(1-ar.length/Math.max(2*lr,1))),s=Math.min(ar.length,12*cr-ar.length),l=Math.max(0,s/(cr/2*12)*_r);i+l,zr.push(o(l,0)),Nr.push(o(i,0)),COBpredBG=ar[ar.length-1]+r+Math.min(0,t)+i+l;var u=Math.max(0,ur+or.length*yr),d=Math.max(0,ur*(1-or.length/Math.max(36,1))),m=Math.min(u,d);m>0&&(Wr=o(5*(or.length+1)/60,1)),UAMpredBG=or[or.length-1]+r+Math.min(0,t)+m,tr.length<48&&tr.push(jr),ar.length<48&&ar.push(COBpredBG),or.length<48&&or.push(UAMpredBG),nr.length<48&&nr.push(n),COBpredBG<Ur&&(Ur=o(COBpredBG)),UAMpredBG<Ar&&(Ar=o(UAMpredBG)),jr<Er&&(Er=o(jr)),n<Pr&&(Pr=o(n));tr.length>18&&jr<Or&&(Or=o(jr)),jr>kr&&(kr=jr),(lr||_r>0)&&ar.length>18&&COBpredBG<Dr&&(Dr=o(COBpredBG)),(lr||_r>0)&&COBpredBG>kr&&(qr=COBpredBG),ir&&or.length>12&&UAMpredBG<Gr&&(Gr=o(UAMpredBG)),ir&&UAMpredBG>kr&&UAMpredBG}))}catch(e){console.error("Problem with iobArray.  Optional feature Advanced Meal Assist disabled")}be.predBGs={},tr.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))}));for(var Lr=tr.length-1;Lr>12&&tr[Lr-1]===tr[Lr];Lr--)tr.pop();for(be.predBGs.IOB=tr,wr=o(tr[tr.length-1]),nr.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),Lr=nr.length-1;Lr>6&&!(nr[Lr-1]>=nr[Lr]||nr[Lr]<=we);Lr--)nr.pop();if(be.predBGs.ZT=nr,o(nr[nr.length-1]),I.mealCOB>0&&(sr>0||_r>0)){for(ar.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),Lr=ar.length-1;Lr>12&&ar[Lr-1]===ar[Lr];Lr--)ar.pop();be.predBGs.COB=ar,Tr=o(ar[ar.length-1]),er=Math.max(er,o(ar[ar.length-1]))}if(sr>0||_r>0){if(ir){for(or.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),Lr=or.length-1;Lr>12&&or[Lr-1]===or[Lr];Lr--)or.pop();be.predBGs.UAM=or,Cr=o(or[or.length-1]),or[or.length-1]&&(er=Math.max(er,o(or[or.length-1])))}be.eventualBG=er}console.error("UAM Impact:"+ur+"mg/dL per 5m; UAM Duration:"+Wr+"hours"),Or=Math.max(39,Or),Dr=Math.max(39,Dr),Gr=Math.max(39,Gr),Fr=o(Or);var Xr=I.mealCOB/I.carbs;Ir=o(Gr<999&&Dr<999?(1-Xr)*UAMpredBG+Xr*COBpredBG:Dr<999?(jr+COBpredBG)/2:Gr<999?(jr+UAMpredBG)/2:jr),Pr>Ir&&(Ir=Pr),Rr=o(Rr=lr||_r>0?ir?Xr*Ur+(1-Xr)*Ar:Ur:ir?Ar:Er);var Yr=Gr;if(Pr<ze)Yr=(Gr+Pr)/2;else if(Pr<we){var Hr=(Pr-ze)/(we-ze);Yr=(Gr+(Gr*Hr+Pr*(1-Hr)))/2}else Pr>Gr&&(Yr=(Gr+Pr)/2);if(Yr=o(Yr),I.carbs)if(!ir&&Dr<999)Fr=o(Math.max(Or,Dr));else if(Dr<999){var Zr=Xr*Dr+(1-Xr)*Yr;Fr=o(Math.max(Or,Dr,Zr))}else Fr=ir?Yr:Rr;else ir&&(Fr=o(Math.max(Or,Yr)));Fr=Math.min(Fr,Ir),process.stderr.write("minPredBG: "+n(Fr,x)+" minIOBPredBG: "+n(Or,x)+" minZTGuardBG: "+n(Pr,x)),Dr<999&&process.stderr.write(" minCOBPredBG: "+n(Dr,x)),Gr<999&&process.stderr.write(" minUAMPredBG: "+n(Gr,x)),console.error(" avgPredBG:"+n(Ir,x)+" COB/Carbs:"+I.mealCOB+"/"+I.carbs),qr>Se&&(Fr=Math.min(Fr,qr)),be.COB=I.mealCOB,be.IOB=a.iob,be.BGI=n(Ke,x),be.insulinForManualBolus=0,be.deviation=n(Qe,x),be.dura_ISFratio=o(M,2),be.bg_ISFratio=o(v,2),be.delta_ISFratio=o(B,2),be.pp_ISFratio=o(_,2),be.acce_ISFratio=o(h,2),be.auto_ISFratio=o(x.sens/Le,2),be.ISF=n(Le,x),be.CR=o(x.carb_ratio,2),be.TDD=o(pe,1),be.TDDytd=o(H,1),be.TDD7d=o(Z,1),be.target_bg=n(we,x);var $r=function(e,r,a,t){if(!e.use_autoisf)return console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),.5;var n=e.smb_delivery_ratio_bg_range;n<10&&(n/=.0555);var i=e.smb_delivery_ratio,s=Math.min(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max),l=Math.max(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max),u=a+e.smb_delivery_ratio_bg_range,d=i;return n>0&&(d=s+(l-s)*(r-a)/n,d=Math.max(s,Math.min(l,d))),"enforced"==t?(console.error("SMB delivery ratio set to "+o(Math.max(i,d),2)+" as max of fixed and interpolated values"),Math.max(i,d)):0==n?(console.error("SMB delivery ratio set to fixed value "+o(i,2)),i):r<=a?(console.error("SMB delivery ratio limited by minimum value "+o(s,2)),s):r>=u?(console.error("SMB delivery ratio limited by maximum value "+o(l,2)),l):(console.error("SMB delivery ratio set to interpolated value "+o(d,2)),d)}(x,Se,we,Xe);be.SMBratio=o($r,2);var Jr="SMB Del.Ratio:, "+o($r,2);be.reason=Jr+f+i+", Standard, COB: "+be.COB+", Dev: "+be.deviation+", BGI: "+be.BGI+", ISF: "+be.ISF+", CR: "+be.CR+", Target: "+be.target_bg+", minPredBG "+n(Fr,x)+", minGuardBG "+n(Rr,x)+", IOBpredBG "+n(wr,x),Tr>0&&(be.reason+=", COBpredBG "+n(Tr,x)),Cr>0&&(be.reason+=", UAMpredBG "+n(Cr,x)),be.reason+=tddReason,be.reason+="; ";var Kr=Ve;Kr<40&&(Kr=Math.min(Rr,Kr));var Qr=ze-Kr,Vr=240,ea=240;if(I.mealCOB>0&&(sr>0||_r>0)){for(Lr=0;Lr<ar.length;Lr++)if(ar[Lr]<Te){Vr=5*Lr;break}for(Lr=0;Lr<ar.length;Lr++)if(ar[Lr]<ze){ea=5*Lr;break}}else{for(Lr=0;Lr<tr.length;Lr++)if(tr[Lr]<Te){Vr=5*Lr;break}for(Lr=0;Lr<tr.length;Lr++)if(tr[Lr]<ze){ea=5*Lr;break}}Ye&&Rr<ze&&(console.error("minGuardBG "+n(Rr,x)+" projected below "+n(ze,x)+" - disabling SMB"),Ye=!1);var ra=.2;void 0!==x.maxDelta_bg_threshold&&(ra=Math.min(x.maxDelta_bg_threshold,.4),console.error("maxDelta threshold for BG-Jump to allow SMB's set to: "+100*ra+"%")),Ie>ra*Se&&(console.error("maxDelta "+n(Ie,x)+" > "+100*ra+"% of BG "+n(Se,x)+" - disabling SMB"),be.reason+="maxDelta "+n(Ie,x)+" > "+100*ra+"% of BG "+n(Se,x)+" - SMB disabled!, ",Ye=!1),console.error("BG projected to remain above "+n(Te,x)+" for "+Vr+"minutes"),(ea<240||Vr<60)&&console.error("BG projected to remain above "+n(ze,x)+" for "+ea+"minutes");var aa=ea,ta=x.current_basal*Le*aa/60,oa=Math.max(0,I.mealCOB-.25*I.carbs),na=(Qr-ta)/csf-oa;ta=o(ta),na=o(na),console.error("naive_eventualBG: "+n(Ve,x)+", bgUndershoot: "+n(Qr,x)+", zeroTempDuration: "+aa+", zeroTempEffect: "+ta+", carbsReq: "+na),"Could not parse clock data"==I.reason?console.error("carbsReq unknown: Could not parse clock data"):na>=x.carbsReqThreshold&&ea<=45&&(be.carbsReq=na,be.reason+=na+" add'l carbs req w/in "+ea+"m; ");var ia=0;if(Se<ze&&a.iob<20*-x.current_basal/60&&xe>0&&xe>rr)be.reason+="IOB "+a.iob+" < "+o(20*-x.current_basal/60,2),be.reason+=" and minDelta "+n(xe,x)+" > expectedDelta "+n(rr,x)+"; ";else if(Se<ze||Rr<ze)return be.reason+="minGuardBG "+n(Rr,x)+"<"+n(ze,x),ia=o(60*((Qr=we-Rr)/Le)/x.current_basal),ia=30*o(ia/30),ia=Math.min(120,Math.max(30,ia)),w.setTempBasal(0,ia,x,be,r);if(x.skip_neutral_temps&&be.deliverAt.getMinutes()>=55)return be.reason+="; Canceling temp at "+be.deliverAt.getMinutes()+"m past the hour. ",w.setTempBasal(0,0,x,be,r);var sa=0,la=he;if(er<Te){if(be.reason+="Eventual BG "+n(er,x)+" < "+n(Te,x),xe>rr&&xe>0&&!na)return Ve<40?(be.reason+=", naive_eventualBG < 40. ",w.setTempBasal(0,30,x,be,r)):(e.delta>xe?be.reason+=", but Delta "+n(Be,x)+" > expectedDelta "+n(rr,x):be.reason+=", but Min. Delta "+xe.toFixed(2)+" > Exp. Delta "+n(rr,x),r.duration>15&&t(he,x)===t(r.rate,x)?(be.reason+=", temp "+r.rate+" ~ req "+he+"U/hr. ",be):(be.reason+="; setting current basal of "+he+" as temp. ",w.setTempBasal(he,30,x,be,r)));sa=o(sa=2*Math.min(0,(er-we)/Le),2);var ua=Math.min(0,(Ve-we)/Le);if(ua=o(ua,2),xe<0&&xe>rr)sa=o(sa*(xe/rr),2);if(la=t(la=he+2*sa,x),r.duration*(r.rate-he)/60<Math.min(sa,ua)-.3*he)return be.reason+=", "+r.duration+"m@"+r.rate.toFixed(2)+" is a lot less than needed. ",w.setTempBasal(la,30,x,be,r);if(void 0!==r.rate&&r.duration>5&&la>=.8*r.rate)return be.reason+=", temp "+r.rate+" ~< req "+la+"U/hr. ",be;if(la<=0){if((ia=o(60*((Qr=we-Ve)/Le)/x.current_basal))<0?ia=0:(ia=30*o(ia/30),ia=Math.min(120,Math.max(0,ia))),ia>0)return be.reason+=", setting "+ia+"m zero temp. ",w.setTempBasal(la,ia,x,be,r)}else be.reason+=", setting "+la+"U/hr. ";return w.setTempBasal(la,30,x,be,r)}if(xe<rr&&(!T||!Ye))return e.delta<xe?be.reason+="Eventual BG "+n(er,x)+" > "+n(Te,x)+" but Delta "+n(Be,x)+" < Exp. Delta "+n(rr,x):be.reason+="Eventual BG "+n(er,x)+" > "+n(Te,x)+" but Min. Delta "+xe.toFixed(2)+" < Exp. Delta "+n(rr,x),r.duration>15&&t(he,x)===t(r.rate,x)?(be.reason+=", temp "+r.rate+" ~ req "+he+"U/hr. ",be):(be.reason+="; setting current basal of "+he+" as temp. ",w.setTempBasal(he,30,x,be,r));if(Math.min(er,Fr)<Ce&&(!T||!Ye))return be.reason+=n(er,x)+"-"+n(Fr,x)+" in range: no temp required",r.duration>15&&t(he,x)===t(r.rate,x)?(be.reason+=", temp "+r.rate+" ~ req "+he+"U/hr. ",be):(be.reason+="; setting current basal of "+he+" as temp. ",w.setTempBasal(he,30,x,be,r));if(er>=Ce&&(be.reason+="Eventual BG "+n(er,x)+" >= "+n(Ce,x)+", "),a.iob>De)return be.reason+="IOB "+o(a.iob,2)+" > max_iob "+De,r.duration>15&&t(he,x)===t(r.rate,x)?(be.reason+=", temp "+r.rate+" ~ req "+he+"U/hr. ",be):(be.reason+="; setting current basal of "+he+" as temp. ",w.setTempBasal(he,30,x,be,r));sa=o((Math.min(Fr,er)-we)/Le,2);var da=o((er-we)/Le,2);sa>De-a.iob&&(be.reason+="max_iob "+De+", ",console.error("InsReq",o(sa,2),"capped at "+o(De-a.iob,2)+" to not exceed max_iob"),sa=De-a.iob),la=t(la=he+2*sa,x),sa=o(sa,3),be.insulinReq=sa,be.insulinForManualBolus=da,be.reason="Ins.Req: "+o(sa,2)+", "+be.reason;var ma=o((new Date(ve).getTime()-a.lastBolusTime)/6e4,1);if(T&&Ye&&Se>ze){var ca=o(I.mealCOB/x.carb_ratio,3);if(x.use_autoisf)pa=x.smb_max_range_extension;else{console.error("autoISF disabled, SMB range extension disabled");var pa=1}pa>1&&console.error("SMB max range extended from default by factor "+pa);var ba=0;void 0===x.maxSMBBasalMinutes?(ba=o(pa*x.current_basal*30/60,1),console.error("profile.maxSMBBasalMinutes undefined: defaulting to 30m")):a.iob>ca&&a.iob>0?(console.error("IOB",a.iob,"> COB",I.mealCOB+"; mealInsulinReq =",ca),x.maxUAMSMBBasalMinutes?(console.error("profile.maxUAMSMBBasalMinutes:",x.maxUAMSMBBasalMinutes,"profile.current_basal:",x.current_basal),ba=o(pa*x.current_basal*x.maxUAMSMBBasalMinutes/60,1)):(console.error("profile.maxUAMSMBBasalMinutes undefined: defaulting to 30m"),ba=o(30*x.current_basal/60,1))):(console.error("profile.maxSMBBasalMinutes:",x.maxSMBBasalMinutes,"profile.current_basal:",x.current_basal),ba=o(pa*x.current_basal*x.maxSMBBasalMinutes/60,1));var ga=x.bolus_increment,fa=1/ga;x.use_autoisf||(console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),$r=.5),$r>.5&&console.error("SMB Delivery Ratio increased from default 0.5 to "+o($r,2));var ha=Math.min(sa*$r,ba);ha=Math.floor(ha*fa)/fa,ia=o(60*((we-(Ve+Or)/2)/Le)/x.current_basal),sa>0&&ha<ga&&(ia=0);var va=0;ia<=0?ia=0:ia>=30?(ia=30*o(ia/30),ia=Math.min(60,Math.max(0,ia))):(va=o(he*ia/30,2),ia=30),ha>=ba&&(be.reason+="; maxBolus "+ba),ia>0&&(be.reason+="; setting "+ia+"m low temp of "+va+"U/h"),be.reason+=". ";var Ba=3;x.SMBInterval&&(Ba=Math.min(10,Math.max(1,x.SMBInterval)));var _a=o(Ba-ma,0),Ma=o(60*(Ba-ma),0)%60;if(console.error("naive_eventualBG "+n(Ve,x)+", "+ia+"m "+va+"U/h temp needed; last bolus "+ma+"m ago; maxBolus: "+ba),ma>Ba?ha>0&&(be.units=ha,be.reason+="Microbolusing "+ha+"U. "):be.reason+="Waiting "+_a+"m "+Ma+"s to microbolus again. ",ia>0)return be.rate=va,be.duration=ia,be}var Sa=w.getMaxSafeBasal(x);return la>Sa&&(be.reason+="adj. req. rate: "+o(la,2)+" to maxSafeBasal: "+o(Sa,2)+", ",la=t(Sa,x)),r.duration*(r.rate-he)/60>=2*sa?(be.reason+=r.duration+"m@"+r.rate.toFixed(2)+" > 2 * insulinReq. Setting temp basal of "+la+"U/hr. ",w.setTempBasal(la,30,x,be,r)):void 0===r.duration||0===r.duration?(be.reason+="no temp, setting "+la+"U/hr. ",w.setTempBasal(la,30,x,be,r)):r.duration>5&&t(la,x)<=t(r.rate,x)?(be.reason+="temp "+r.rate+" >~ req "+la+"U/hr. ",be):(be.reason+="temp "+r.rate+"<"+la+"U/hr. ",w.setTempBasal(la,30,x,be,r))}},6880:(e,r,a)=>{var t=a(6654);e.exports=function(e,r){var a=20;void 0!==r&&"string"==typeof r.model&&(t(r.model,"54")||t(r.model,"23"))&&(a=40);return e<1?Math.round(e*a)/a:e<10?Math.round(20*e)/20:Math.round(10*e)/10}},2705:(e,r,a)=>{var t=a(5639).Symbol;e.exports=t},9932:e=>{e.exports=function(e,r){for(var a=-1,t=null==e?0:e.length,o=Array(t);++a<t;)o[a]=r(e[a],a,e);return o}},9750:e=>{e.exports=function(e,r,a){return e==e&&(void 0!==a&&(e=e<=a?e:a),void 0!==r&&(e=e>=r?e:r)),e}},4239:(e,r,a)=>{var t=a(2705),o=a(9607),n=a(2333),i=t?t.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?o(e):n(e)}},531:(e,r,a)=>{var t=a(2705),o=a(9932),n=a(1469),i=a(3448),s=t?t.prototype:void 0,l=s?s.toString:void 0;e.exports=function e(r){if("string"==typeof r)return r;if(n(r))return o(r,e)+"";if(i(r))return l?l.call(r):"";var a=r+"";return"0"==a&&1/r==-Infinity?"-0":a}},7561:(e,r,a)=>{var t=a(7990),o=/^\s+/;e.exports=function(e){return e?e.slice(0,t(e)+1).replace(o,""):e}},1957:(e,r,a)=>{var t="object"==typeof a.g&&a.g&&a.g.Object===Object&&a.g;e.exports=t},9607:(e,r,a)=>{var t=a(2705),o=Object.prototype,n=o.hasOwnProperty,i=o.toString,s=t?t.toStringTag:void 0;e.exports=function(e){var r=n.call(e,s),a=e[s];try{e[s]=void 0;var t=!0}catch(e){}var o=i.call(e);return t&&(r?e[s]=a:delete e[s]),o}},2333:e=>{var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},5639:(e,r,a)=>{var t=a(1957),o="object"==typeof self&&self&&self.Object===Object&&self,n=t||o||Function("return this")();e.exports=n},7990:e=>{var r=/\s/;e.exports=function(e){for(var a=e.length;a--&&r.test(e.charAt(a)););return a}},6654:(e,r,a)=>{var t=a(9750),o=a(531),n=a(554),i=a(9833);e.exports=function(e,r,a){e=i(e),r=o(r);var s=e.length,l=a=void 0===a?s:t(n(a),0,s);return(a-=r.length)>=0&&e.slice(a,l)==r}},1469:e=>{var r=Array.isArray;e.exports=r},3218:e=>{e.exports=function(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)}},7005:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},3448:(e,r,a)=>{var t=a(4239),o=a(7005);e.exports=function(e){return"symbol"==typeof e||o(e)&&"[object Symbol]"==t(e)}},8601:(e,r,a)=>{var t=a(4841),o=1/0;e.exports=function(e){return e?(e=t(e))===o||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},554:(e,r,a)=>{var t=a(8601);e.exports=function(e){var r=t(e),a=r%1;return r==r?a?r-a:r:0}},4841:(e,r,a)=>{var t=a(7561),o=a(3218),n=a(3448),i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,l=/^0o[0-7]+$/i,u=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(n(e))return NaN;if(o(e)){var r="function"==typeof e.valueOf?e.valueOf():e;e=o(r)?r+"":r}if("string"!=typeof e)return 0===e?e:+e;e=t(e);var a=s.test(e);return a||l.test(e)?u(e.slice(2),a?2:8):i.test(e)?NaN:+e}},9833:(e,r,a)=>{var t=a(531);e.exports=function(e){return null==e?"":t(e)}}},r={};function a(t){var o=r[t];if(void 0!==o)return o.exports;var n=r[t]={exports:{}};return e[t](n,n.exports,a),n.exports}a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();var t=a(5546);freeaps_determineBasal=t})();